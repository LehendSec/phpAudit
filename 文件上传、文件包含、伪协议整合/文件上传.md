### 文件上传

#### 文件上传代码审计

```
直接锁定函数 
1、move_uploaded_file($tmp_file,$path) 向上追踪这个函数的$path参数，得到$path的方式方式有多种
2、fopen和fwrite函数 这种情况很少
```

#### 文件上传碰到的函数

```
1、trim() 去除字符串两端的空格

2、strrchr($fileName,'.')                     
	获取 . 最后一次出现的位置，将  . 到最后的所有内容获取作为文件的后缀
	
3、deldot($file_name); 删除文件名称末尾的. 

4、str_replace() 进行字符串替换，有的会替换为空

5、image_type_to_extension           
	根据指定的图像类型返回对应的后缀名。
	
6、
   $file = fopen($filename, "rb");//打开临时文件
    $bin = fread($file, 2); //只读2字节 类型为二进制数据
    fclose($file);
    //从二进制图片流中读取数据，每读取一个字节返回对应的ascii值，以数组返回         
    //$strInfo {char1=> 123,char2=>235}          
    $strInfo = @unpack("C2chars", $bin);               
    @unpack将二进制字符转换为可视字符
7、
    strrpos                                                                         
        计算指定字符串在目标字符串中最后一次出现的位置                                                        
    strrpos ( string $haystack , string $needle [, int $offset = 0 ] ) 
    返回值:   返回字符串 haystack 中 needle 最后一次出现的数字位置。
```

#### 文件上传校验类型

##### 一、本地js验证

**(通常为检测文件扩展名)**

##### 二、服务器MIME检测

 **content-type 方式绕过 直接更改 content-type的内容，只要content-type内容符合服务器白名单即可.**

##### 三、服务端文件上传路径检测 

**(检测跟 上传路径 相关的内容)(上传文件的数据包很可能带有上传的路径，有的cms会对文件上传的路径做校验)**

##### 四、服务端文件后缀检测 

​	**黑名单**

​	**白名单**

```
如何利用?(白名单校验)
    1、推荐使用图片马+解析漏洞进行利用
    2、推荐使用图片马+文件包含的方式进行利用
```

##### 五、服务端文件内容拓展名检测

##### 六、服务端对上传的图片进行二次渲染

​		**服务端文件内容拓展检测方式**

```
1.文件幻数检测 jpg(JFIF) gif(GIF89a) png(%PNG)
2.文件相关信息检测(文件头加一些图片信息中间夹杂攻击代码）
3.文件加载检测(调用API或者函数进行文件加载测试   php的 gd库)

```

#### 文件上传绕过方式：

```
0、使用垃圾字符消耗waf内存,一般垃圾字符较多。
1、
	%00截断，主要是由于php是用C语言编写的，php相关函数(move_uploaded_file)读到（0x00）时，会认为文件已经结束，会自动截断后面的内容。(5.2 c语言中将\0当作字符串的结尾)   例如: shell.php%00.jpg 需要使用ctrl + shift + u对%00进行编码 ，编码之后%00可能会形成小方块或则消失.PHP 5.4之后00截断漏洞已经修复
	
2、  
	. .绕过，. .  windows系统会自动去掉后面的.后面的内容，使用方式                                  
eg: filename="muma.php. . "                 
filename="muma.php.  "

3、空格绕过——>没有trim()函数过滤空格情况

4、  
	::$DATA绕过：php在windows系统下,如果为:文件名.文件后缀::$DATA(例如:xx.php::$DATA),         
会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持"::$DATA"之前的文件名

5、.htaccess文件攻击（结合黑名单攻击）  
	.htaccess攻击成功前提
		.htaccess文件作为局部变量作用文件成功作用的两个条件                                                       
            1、开启Allow Override All   允许上传的文件重复时进行替换                      
            2、LoadModule rewrite_module modules/mod_rewrite.so #rewrite模块为开启状态  (没有被注释)  该内容在httpd.cong文件中，默认被注释                                                     
            3、服务器没有对上传的.htacess文件进行重命名
    .htacess利用
    	 <FilesMatch "需要解析的文件名称">
SetHandler application/x-httpd-php
</FilesMatch>   
       一般用于黑名单绕过，通move_upload_file将自己写的.htacess文件上传到服务器，覆盖掉服务器的.htacess文件，这样可以解析自定义的文件   推荐先上传图片马，这样获得了上传之后的图片马名称之后即可构造对应的.htacess文件,这样上传的自定义文件代码就能够解析了
6、黑名单绕过
	大小写绕过
	黑名单爆破
	双写
```


#### 条件竞争

​		**定义:**                  

```                                      
服务器允许用户上传脚本，但是如果文件上传到服务器之后文件不符合检测的要求，将该文件删除
```

​		**如何判断存在竞争上传？**                             

```
上传文件提示成功了，但是上传文件之后访问提示404，访问文件不存在。很大可能是竞争上传
```

​		**如何利用?**                        
```
条件:
	上传后文件名称不改变（必须条件）
基于上传文件后名称不改变,利用多线程并发访问触发上传后的文件(访问到就会触发)，在该文件没有删除之前触发生成一个新的脚本，连接新的脚本就能够getshell
```


​    